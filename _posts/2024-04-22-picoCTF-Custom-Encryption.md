**CTF:** [picoCTF](https://picoctf.org/) (from March 12, 2024 to March 26, 2024)

**Challenge-Name:** Custom Encryption

**Category:** Crypto

**Difficulty:** 100 points

**Challenge-Author:** NGIRIMANA SCHADRACK

**Writeup by:** Hanna3-14

## Description
Can you get sense of this code file and write the function that will decode the given encrypted file content.

Find the encrypted file here `flag_info` and `code file` might be good to analyze and get the flag.

## Attachments
`custom_encryption.py`:
```python
from random import randint
import sys


def generator(g, x, p):
	return pow(g, x) % p


def encrypt(plaintext, key):
	cipher = []
	for char in plaintext:
		cipher.append(((ord(char) * key*311)))
	return cipher


def is_prime(p):
	v = 0
	for i in range(2, p + 1):
		if p % i == 0:
			v = v + 1
	if v > 1:
		return False
	else:
		return True


def dynamic_xor_encrypt(plaintext, text_key):
	cipher_text = ""
	key_length = len(text_key)
	for i, char in enumerate(plaintext[::-1]):
		key_char = text_key[i % key_length]
		encrypted_char = chr(ord(char) ^ ord(key_char))
		cipher_text += encrypted_char
	return cipher_text


def test(plain_text, text_key):
	p = 97
	g = 31
	if not is_prime(p) and not is_prime(g):
		print("Enter prime numbers")
		return
	a = randint(p-10, p)
	b = randint(g-10, g)
	print(f"a = {a}")
	print(f"b = {b}")
	u = generator(g, a, p)
	v = generator(g, b, p)
	key = generator(v, a, p)
	b_key = generator(u, b, p)
	shared_key = None
	if key == b_key:
		shared_key = key
	else:
		print("Invalid key")
		return
	semi_cipher = dynamic_xor_encrypt(plain_text, text_key)
	cipher = encrypt(semi_cipher, shared_key)
	print(f'cipher is: {cipher}')


if __name__ == "__main__":
	message = sys.argv[1]
	test(message, "trudeau")

```

`enc_flag`:
```
a = 94
b = 21
cipher is: [131553, 993956, 964722, 1359381, 43851, 1169360, 950105, 321574, 1081658, 613914, 0, 1213211, 306957, 73085, 993956, 0, 321574, 1257062, 14617, 906254, 350808, 394659, 87702, 87702, 248489, 87702, 380042, 745467, 467744, 716233, 380042, 102319, 175404, 248489]
```
## Writeup

### Understanding the Challenge
For this challenge a custom encryption has been implemented.
The encryption is done in two steps.
A semi cipher is generated by the first step and then encrypted within the second step.
Within the first step the plaintext is reversed.
The reversed string is then encrypted based on a stream cipher with the word "trudeau" as the key.
The result of this stream cipher is the semi cipher.

This semi cipher is used as the plaintext for the second step.
Within the second step, the ordinal number of each character is multiplied by a key and afterwards multiplied by 311.
The key stays the same for each character.

### Solving the Challenge
For decrypting the flag, the second step has to be decrypted first.
The resulting semi cipher can then be decrypted by reverting the first step.

As I know the values of `p` and `g`, I can easily calculate the key that has been used within the second step of the encryption.
The key can be calculated as `key = g ^ (a * b) % p`.
Afterwards I can undo the second step of the encryption by dividing each number of the cipher by 311 and afterwards dividing it by the calculated key.

For reverting the first encryption step I applied the same stream cipher with the same key ("trudeau") that has been used for the encryption.
As the XOR operation is inverse to itself, this will decrypt the cipher.
Finally, I had to reverse the string again to get the flag in the correct format.

#### Solve Script
```python
a = 94
b = 21
cipher = [131553, 993956, 964722, 1359381, 43851, 1169360, 950105, 321574, 1081658, 613914, 0, 1213211, 306957, 73085, 993956, 0, 321574, 1257062, 14617, 906254, 350808, 394659, 87702, 87702, 248489, 87702, 380042, 745467, 467744, 716233, 380042, 102319, 175404, 248489]

p = 97
g = 31
shared_key = (g ** (a * b)) % p

semi_cipher = []
for number in cipher:
	semi_cipher.append(int((number / 311) / shared_key))

text_key = "trudeau"
flag = ""
for i, char in enumerate(semi_cipher):
	flag += chr(char ^ ord(text_key[i % len(text_key)]))

flag = flag[::-1]
print(flag)
```

### flag
`picoCTF{custom_d2cr0pt6d_8b41f976}`
